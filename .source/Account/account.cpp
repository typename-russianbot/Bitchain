#include "../../includes/Account/account.h"

// TODO - @defgroup: Resources
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: Account(const string, const string) -- done
Account::Account(const string newUsername, const string newPasskey) : username(newUsername), passkey(newPasskey), keys(0), bitchain() { return; }
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: ~Account(void) -- done
Account::~Account(void) { return; }
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// TODO - @defgroup: Functions
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: add(void) -- done
void Account::add(void)
{
    //* @note: grab keyname, username, email, & password
    string keyname, username, email, password;
    do
    {
        cout << "Keyname: ";
        cin >> keyname;
    } while (!InputValidation(keyname));
    do
    {
        cout << "Username: ";
        cin >> username;
    } while (!InputValidation(username));
    do
    {
        cout << "Email: ";
        cin >> email;
    } while (!InputValidation(email));
    do
    {
        cout << "Password: ";
        HideTerminal();

        cin >> password;
        ShowTerminal();
    } while (!InputVerification(password));

    //* @note: pass user input into key object
    Key key(keyname, {username, password, email});

    //* @note: add key to bitchain
    cout << "Add Key | ";
    if (ConfirmOperation())
    {
        bitchain.add(key);
        keys++;
        cout << "Added '" << keyname << "'" << endl;
    }
    else
        cout << "Operation Terminated" << endl;

    return;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: remove(void) -- done
void Account::remove(void)
{
    //* @note: grab target keyname to remove
    string target;
    do
    {
        cout << "Target: ";
        cin >> target;
    } while (!InputValidation(target));

    //* @note: search for target
    if (bitchain.search(target))
    {
        cout << "Remove Key | ";
        if (ConfirmOperation())
        {
            bitchain.remove(target);
            keys--;
            cout << "Removed '" << target << "'" << endl;
        }
        else
            cout << "Operation Terminated" << endl;
    }
    else
        cout << "'" << target << "' not found" << endl; //! @note: miss

    return;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: search(void) -- done
void Account::search(void)
{
    //* @note: grab search target
    string target;
    do
    {
        cout << "Target: ";
        cin >> target;
    } while (!InputValidation(target));

    //* @note: search bitchain for user' target
    if (bitchain.search(target))
        cout << "'" << target << "' found" << endl; //* target found
    else
        cout << "'" << target << "' not found" << endl; //! target not found

    return;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: print(void) -- done
void Account::print(void)
{
    cout << bitchain;
    return;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: save(void) -- done
bool Account::save(void)
{
    //* @note: grab & validate resource savefile
    ofstream outputfile(".resources/Accounts/accounts.txt", ios::app);
    if (!FileValidation(outputfile))
    {
        cerr << "File failed to open" << endl;
        return false;
    }

    //* @note: grab user confirmation
    cout << "Save Bitchain Account | ";
    if (!ConfirmOperation())
    {
        cout << "Operation Terminated" << endl;
        outputfile.close();
        return false;
    }

    //* @note: write Account contents to 'accounts.txt'
    outputfile << username << "," << passkey << "," << keys << endl;
    outputfile.close();
    cout << "Bitchain account saved" << endl;

    return true;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: wipe(void) -- done
bool Account::wipe(void)
{
    //* @note: grab & validate inputfile, create new tempfile
    ifstream inputfile(".resources/Accounts/accounts.txt");
    if (!FileValidation(inputfile))
    {
        cerr << "File failed to open" << endl;
        return false;
    }

    //* @note: grab user confirmation
    cout << "Wipe Bitchain Account | ";
    if (!ConfirmOperation())
    {
        cout << "Operation Terminated" << endl;
        inputfile.close();

        return false;
    }

    ofstream tempfile(".resources/Accounts/temp.txt");

    //* @note: copy all inputfile contents except target
    string line;
    while (getline(inputfile, line))
    {
        if (line.find(username) == string::npos)
            tempfile << line << endl;
    }

    inputfile.close();
    tempfile.close();
    rename(".resources/Accounts/temp.txt", ".resources/Accounts/accounts.txt");
    cout << "Bitchain account wiped" << endl;

    return true;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: load(const string)
bool Account::load(void) { return false; }
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// TODO - @defgroup: Mutators
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: setUsername(const string) -- done
void Account::setUsername(const string nUsername)
{
    username = nUsername;
    return;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: setPasskey(const string) -- done
void Account::setPasskey(const string nPasskey)
{
    passkey = nPasskey;
    return;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: setKeys(const int) -- done
void Account::setKeys(const int nKeys)
{
    keys = nKeys;
    return;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// TODO - @defgroup: Accessors
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: getUsername(void) -- done
const string Account::getUsername(void) { return username; }
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: getPasskey(void) -- done
const string Account::getPasskey(void) { return passkey; }
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: getKeys(void) -- done
int Account::getKeys(void) { return keys; }
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// TODO - @defgroup: Overloads
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//* @public: operator<<(ostream&, const Account&) -- done
ostream &operator<<(ostream &out, const Account &account)
{
    out << "|--------------------------------------------------|" << endl
        << "   Bitchain Account" << endl
        << "\t- Username:\t" << account.username << endl
        << "\t- Passkey:\t" << account.passkey << endl
        << "\t- Keys:\t\t" << account.keys << endl
        << "|--------------------------------------------------|";

    return out;
}
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
